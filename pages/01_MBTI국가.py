import streamlit as st
import pandas as pd
import plotly.express as px

# 0. ìŠ¤íŠ¸ë¦¼ë¦¿ í´ë¼ìš°ë“œì—ì„œ ì‘ë™ë˜ëŠ” ì½”ë“œ
st.set_page_config(layout="wide") # í˜ì´ì§€ ë ˆì´ì•„ì›ƒì„ ë„“ê²Œ ì„¤ì •í•´ìš”!

st.title("ğŸŒ MBTI ìœ í˜• êµ­ê°€ë³„ ë¶„í¬ ë¶„ì„ê¸° ğŸ“Š")
st.markdown("---")

# ğŸ“Œ ê°€ìƒì˜ ë°ì´í„° ìƒì„± (ì‹¤ì œ ë°ì´í„°ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë©°, ì˜ˆì‹œë¥¼ ìœ„í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!)
# ì´ ë°ì´í„°ëŠ” ì´ì „ ëŒ€í™”ì—ì„œ ì–¸ê¸‰ëœ 'countriesMBTI_16types' íŒŒì¼ì„ ëª¨ë°©í•˜ì—¬ ë§Œë“  ì˜ˆì‹œ ë°ì´í„°ì…ë‹ˆë‹¤.
# ì‹¤ì œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì‹œë ¤ë©´ ì´ ë¶€ë¶„ì„ ìˆ˜ì •í•´ ì£¼ì„¸ìš”!
# (ë°ì´í„° ì¶œì²˜: ì–¸ê¸‰ëœ ë¸”ë¡œê·¸ ê¸€ì„ ì°¸ì¡°í•˜ì—¬ íŠ¹ì • êµ­ê°€ì˜ ë†’ì€ ë¹„ìœ¨ ìœ í˜•ì„ ë°˜ì˜í–ˆì–´ìš”.)
data = {
    'Country': ['South Korea', 'Portugal', 'Netherlands', 'Japan', 'USA', 'Germany', 'France', 'Brazil', 'Canada', 'Australia'],
    'ISTJ': [0.10, 0.08, 0.07, 0.09, 0.12, 0.09, 0.08, 0.11, 0.10, 0.09],
    'ISFJ': [0.12, 0.09, 0.10, 0.11, 0.13, 0.11, 0.10, 0.12, 0.11, 0.10],
    'INFJ': [0.05, 0.06, 0.08, 0.04, 0.06, 0.07, 0.09, 0.05, 0.07, 0.06],
    'INTJ': [0.03, 0.04, 0.05, 0.03, 0.04, 0.05, 0.06, 0.03, 0.05, 0.04],
    'ISTP': [0.07, 0.08, 0.09, 0.08, 0.09, 0.08, 0.07, 0.07, 0.08, 0.09],
    'ISFP': [0.09, 0.2059, 0.08, 0.07, 0.08, 0.07, 0.09, 0.08, 0.07, 0.08], # í¬ë¥´íˆ¬ê°ˆ 6ë²ˆì§¸ ìœ í˜• ë†’ìŒ (0.2059) ë°˜ì˜
    'INFP': [0.08, 0.07, 0.06, 0.09, 0.07, 0.06, 0.08, 0.09, 0.06, 0.07],
    'INTP': [0.06, 0.05, 0.07, 0.06, 0.05, 0.07, 0.05, 0.06, 0.07, 0.06],
    'ESTP': [0.04, 0.03, 0.05, 0.04, 0.03, 0.04, 0.03, 0.04, 0.03, 0.05],
    'ESFP': [0.06, 0.05, 0.04, 0.05, 0.06, 0.05, 0.04, 0.06, 0.05, 0.04],
    'ENFP': [0.07, 0.08, 0.09, 0.08, 0.09, 0.08, 0.07, 0.07, 0.08, 0.09],
    'ENTP': [0.126, 0.06, 0.07, 0.09, 0.06, 0.07, 0.08, 0.06, 0.07, 0.08], # í•œêµ­ 12ë²ˆì§¸ ìœ í˜• ë†’ìŒ (0.126) ë°˜ì˜
    'ESTJ': [0.05, 0.04, 0.03, 0.06, 0.04, 0.03, 0.05, 0.05, 0.04, 0.03],
    'ESFJ': [0.08, 0.07, 0.06, 0.07, 0.08, 0.07, 0.06, 0.08, 0.07, 0.06],
    'ENFJ': [0.06, 0.07, 0.08, 0.05, 0.07, 0.08, 0.07, 0.06, 0.08, 0.07],
    'ENTJ': [0.02, 0.01, 0.02, 0.01, 0.02, 0.02, 0.03, 0.02, 0.02, 0.01] # ì „ì„¸ê³„ì ìœ¼ë¡œ í¬ì†Œí•œ ENTJ ë°˜ì˜
}
df = pd.DataFrame(data)

# 'South Korea'ì˜ ISFP ê°’ì„ 0.1339ë¡œ ì¡°ì •í•˜ì—¬ ë†’ì€ 6ë²ˆì§¸ ìœ í˜•(ISFP)ì„ ë°˜ì˜
# ë‹¨, ì›ë³¸ ë°ì´í„°ì—ì„œ 6ë²ˆì§¸ ìœ í˜•ì´ ISFPë¼ê³  í™•ì •ëœ ê²ƒì€ ì•„ë‹ˆë¯€ë¡œ, ì˜ˆì‹œ ëª©ì ìœ¼ë¡œ ì„ì˜ í• ë‹¹í–ˆìŠµë‹ˆë‹¤.
df.loc[df['Country'] == 'South Korea', 'ISFP'] = 0.1339

st.sidebar.header("êµ­ê°€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” ğŸ‡°ğŸ‡·")
selected_country = st.sidebar.selectbox(
    "ë°ì´í„°ë¥¼ ë³´ê³  ì‹¶ì€ êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”:",
    df['Country'].unique()
)

# ì„ íƒëœ êµ­ê°€ì˜ ë°ì´í„° í•„í„°ë§
country_data = df[df['Country'] == selected_country]

if not country_data.empty:
    # MBTI ìœ í˜• ì»¬ëŸ¼ë§Œ ì„ íƒ
    mbti_types = country_data.drop('Country', axis=1).iloc[0]
    
    # ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ Plotlyì—ì„œ ì‚¬ìš©í•˜ê¸° ì¢‹ê²Œ ë§Œë“­ë‹ˆë‹¤.
    mbti_df = pd.DataFrame({'MBTI Type': mbti_types.index, 'Percentage': mbti_types.values})
    mbti_df['Percentage'] = mbti_df['Percentage'] * 100 # ë¹„ìœ¨ì„ %ë¡œ ë³€í™˜

    # 3. ê·¸ë˜í”„ ìƒ‰ 1ë“±ì€ ë¶„í™ìƒ‰, ë‚˜ë¨¸ì§€ëŠ” íŒŒìŠ¤í…”í†¤ìœ¼ë¡œ ê·¸ë ¤ì¤˜.
    # ê°€ì¥ ë†’ì€ ë¹„ìœ¨ì„ ê°€ì§„ MBTI ìœ í˜•ì„ ì°¾ìŠµë‹ˆë‹¤.
    top_mbti_type = mbti_df.loc[mbti_df['Percentage'].idxmax()]
    
    # Plotly ì»¤ìŠ¤í…€ ìƒ‰ìƒ ë§¤í•‘
    # íŒŒìŠ¤í…” ìƒ‰ìƒ íŒ”ë ˆíŠ¸ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
    pastel_colors = px.colors.qualitative.Pastel # Plotlyì˜ ê¸°ë³¸ íŒŒìŠ¤í…” íŒ”ë ˆíŠ¸ ì‚¬ìš©
    
    # ìƒ‰ìƒ ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ê°€ì¥ ë†’ì€ ë¹„ìœ¨ì˜ ìœ í˜•ì€ 'ë¶„í™ìƒ‰'ìœ¼ë¡œ, ë‚˜ë¨¸ì§€ëŠ” íŒŒìŠ¤í…”í†¤ìœ¼ë¡œ ì±„ì›ë‹ˆë‹¤.
    # (Plotly Expressì˜ `color_discrete_map` ì‚¬ìš©)
    color_map = {mbti_type: pastel_colors[i % len(pastel_colors)] for i, mbti_type in enumerate(mbti_df['MBTI Type'])}
    color_map[top_mbti_type['MBTI Type']] = '#FF69B4' # í•«í•‘í¬ ìƒ‰ìƒ (ë¶„í™ìƒ‰ ê°•ì¡°!)

    # 1. plotlyë¥¼ ì‚¬ìš©í•´ì„œ ì¸í„°ë ‰í‹°ë¸Œí•œ ë°ì´í„°ë¥¼ ê·¸ë ¤ì¤˜.
    # 2. êµ­ê°€ë¥¼ ì„ íƒí•˜ë©´ ê° êµ­ê°€ì˜ MBTI ë¹„ìœ¨ì„ ë§‰ëŒ€ê·¸ë˜í”„ë¡œ ê·¸ë ¤ì¤˜.
    fig = px.bar(
        mbti_df,
        x='MBTI Type',
        y='Percentage',
        title=f"ğŸ“ˆ {selected_country}ì˜ MBTI ìœ í˜• ë¶„í¬",
        labels={'MBTI Type': 'MBTI ìœ í˜•', 'Percentage': 'ë¹„ìœ¨ (%)'},
        hover_data={'MBTI Type': True, 'Percentage': ':.2f%'}, # ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì •ë³´ í‘œì‹œ
        color='MBTI Type', # MBTI ìœ í˜•ë³„ë¡œ ìƒ‰ìƒì„ ë‹¤ë¥´ê²Œ ì ìš©
        color_discrete_map=color_map, # ì •ì˜í•œ ì»¤ìŠ¤í…€ ìƒ‰ìƒ ë§µ ì ìš©
        height=500
    )

    # ê·¸ë˜í”„ ë ˆì´ì•„ì›ƒ ì»¤ìŠ¤í„°ë§ˆì´ì§•
    fig.update_layout(
        xaxis_title="MBTI ìœ í˜•",
        yaxis_title="ë¹„ìœ¨ (%)",
        xaxis_tickangle=-45,
        font=dict(family="Arial, sans-serif", size=14),
        hovermode="x unified" # ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ xì¶• ê¸°ì¤€ìœ¼ë¡œ ì •ë³´ í†µì¼
    )

    st.plotly_chart(fig, use_container_width=True)

    st.markdown("---")
    st.subheader(f"ğŸ“Š {selected_country} MBTI ìœ í˜• ë¹„ìœ¨ ìš”ì•½")
    st.dataframe(mbti_df.set_index('MBTI Type').T.style.format('{:.2f}%'), use_container_width=True)

else:
    st.error("ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ã… ã… ")

st.markdown("---")
st.info("ì´ ë¶„ì„ê¸°ëŠ” ê°€ìƒ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œê°í™”í•œ ê²ƒì…ë‹ˆë‹¤. ì‹¤ì œ MBTI ë¶„í¬ëŠ” ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ˜Š")
